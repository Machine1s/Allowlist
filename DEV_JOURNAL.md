# 🛡️ Allowlist Generator 开发实战复盘 (v1.0)

> 本文档总结了 v1.0 开发过程中的关键技术决策、测试策略、故障排查经验以及最佳实践。

[English Version](DEV_JOURNAL_EN.md)

## 1. 核心业务逻辑：从“这就行了”到“严谨规范”

我们超越了简单的输入处理，深入到了**网络工程**的规范层面：

*   **边界控制**：重构了 `splitIpRange` 算法，强制**剔除**所有网络地址 (`.0`) 和广播地址 (`.255`)。这确保了生成的规则在防火墙中是 100% 合法且安全的。
*   **严格校验**：拒绝 "1" 或 "192.168" 这种模糊输入，只接受合法的 IPv4 主机地址。
*   **全局查重**：利用 `react.useMemo` 实时计算并高亮跨策略的冲突 IP，解决了“策略冲突”的隐患。

## 2. 测试策略：构建“代码的保险丝”

我们实践了完整的**测试金字塔 (Test Pyramid)** 模型：

### A. 单元测试 (Unit Tests) - 基座
*   **对象**：`src/lib/ip-utils.ts`
*   **目的**：验证复杂算法逻辑（例如：跨 C 段的 IP 切割，如 `0.254` 到 `1.1`）。
*   **关键文件**：`ip-boundary.test.ts`

### B. 集成测试 (Integration Tests) - 胶水层
*   **对象**：`src/components/PolicyTable.test.tsx`
*   **目的**：验证组件交互逻辑，如批量选择、删除、验证反馈等。
*   **经验**：在测试环境中 Mock 浏览器行为（如 `window.confirm`）至关重要。

### C. 用户旅程测试 (User Journey Tests) - 剧本
*   **对象**：`src/App.test.tsx`
*   **目的**：模拟真实用户操作流：*创建策略 -> 改名 -> 添加IP -> 复制 -> 导出*。
*   **理念**：我们不关心代码实现细节（是 div 还是 span），只关心用户在屏幕上看到了什么。

## 3. 故障排查案例：消失的“删除”功能

**现象**：集成测试全绿通过，但在浏览器中点击“删除”按钮毫无反应。
**根因**：浏览器（或插件）拦截/自动取消了原生的 `window.confirm` 弹窗。
**教训**：
1.  **测试环境 ≠ 真实环境**：JSDOM（测试环境）是真空的，真实浏览器是复杂的。测试通过不代表 UI 可用。
2.  **避免原生控件**：在现代 Web 应用中，尽量避免使用 `alert`/`confirm`。应使用状态控制的自定义 Modal。
3.  **日志为王**：当逻辑看似完美时，一行简单的 `console.log` 瞬间揭示了“取消事件”的真相。

## 4. 🔬 浏览器 DevTools 调试指南

在解决 UI 问题时，我们深度依赖了浏览器 F12 工具：

### A. 元素定位 (Component Locating)
*   **操作**：`右键 -> 检查 (Inspect)`
*   **用法**：复制具体的 Tailwind 类名（如 `bg-red-50`）发给 AI 助手。
*   **价值**：这能让 AI 在几千行代码中瞬间定位到具体的按钮，比描述“左上角红色的那个”快 10 倍。

### B. React Components 面板
*   **问题**：页面上有两个一模一样的弹窗组件 (`MultiInputModal`)，到底是哪一个在起作用？
*   **解法**：打开 DevTools 的 **Components** 标签页，查看它们的 `props`（如 `title` 是 "Manage IP" 还是 "Manage Port"）。
*   **价值**：瞬间判断当前激活的组件实例。

### C. Console 作为逻辑探针
*   **策略**：在事件处理函数的第一行打上 `console.log`。
*   **价值**：
    *   无输出 = 事件绑定失败（可能是 CSS 遮挡或 z-index 问题）。
    *   有输出 = 逻辑逻辑执行中断（被 `if` 条件拦截）。

## 5. 发布前的“起飞检查” (Pre-flight Check)

在 `git push` 之前，我们执行了严格的质量门禁：

*   **`npm run build`**：不仅是打包，更是最严厉的 TypeScript 语法检查官。它帮我们发现了 5 个潜在问题。
*   **类型修复**：显式修复 `tsconfig`，确保测试文件类型安全。
*   **清理**：将临时调试文件 (`debug_boundary`) 规范化命名 (`ip-boundary`)，删除无用代码。

---

**总结**：
> 通过“严格类型”约束逻辑，通过“全链路测试”保障质量，通过“DevTools 精准定位”解决疑难杂症，最终交付了一个工业级质量的配置生成工具。

---

*Documentation & Code co-authored by **Antigravity** (Google DeepMind).*
